# v1.2.0 ‚Äî Performance & Architecture Improvements

This release focuses on significant performance optimizations, architectural improvements, and enhanced reliability for the Espelho de S√£o Miguel Nostr relay aggregator.

## üöÄ Performance & Optimization

### Internal Query Filtering
- **Intelligent caching mechanism** for internal query requests to batch related operations and reduce upstream relay load
- **3-second cache timeout** for optimal batching without significant delays
- **Automatic cleanup** of expired cache entries to prevent memory leaks

### Efficient Blocked Event Lookup
- **O(1) map lookup** instead of O(n) iteration for blocked event detection
- **Significantly improved performance** for deletion request processing
- **Direct map access** for blocked events using optimized key structure

### Optimized Cache Locking
- **Reduced lock contention** with dedicated helper methods
- **Minimized critical section duration** during cache operations
- **Better concurrency** for high-traffic scenarios

### Smart Internal Request Detection
- **Enhanced detection** of internal requests using since filter checks
- **Prevents incorrect classification** of legitimate client requests as internal
- **More precise filtering** for internal operations

## üîß Architecture & Code Quality

### Separated Mirroring Functionality
- **Extracted mirroring logic** into dedicated `mirror` package for better modularity
- **Improved reusability** of core relaystore functionality in other projects
- **Cleaner separation** of concerns between event forwarding and mirroring

### Simplified Constructor API
- **Streamlined RelayStore constructor** with intuitive parameter order
- **Query relays mandatory**, publish relays optional for better configuration clarity
- **Removed deprecated constructors** for cleaner public API

### Removed Default Configurations
- **Require explicit configuration** for all components to prevent unexpected behavior
- **Fail-fast approach** when required configuration is missing
- **Better error messages** for configuration issues

### Enhanced Internal Request Handling
- **Improved detection** and handling of internal khatru requests
- **Prevents unnecessary upstream forwarding** of internal operations
- **Better isolation** between internal and external request processing

## üõ°Ô∏è Reliability & Error Handling

### Internal Query Blocking
- **Proper blocking mechanism** for internal query requests
- **3-second cache timeout** for optimal blocking duration
- **Automatic cleanup** of blocked event entries

### Internal Request Filtering
- **Comprehensive filtering** to prevent internal khatru operations from being forwarded to upstream relays
- **Better isolation** of internal operations
- **Improved security** by preventing internal request leakage

### Improved Cache Management
- **Enhanced cache cleanup** and management with better error handling
- **Resource optimization** for memory usage
- **Automatic expiration** of cache entries

## üìä Technical Improvements

### Better Debugging
- **Enhanced debug logging** for internal requests and blocked events
- **Improved troubleshooting** capabilities for complex scenarios
- **Better visibility** into internal operations

### Cleaner API
- **Removed deprecated constructors** and simplified the public API surface
- **More intuitive parameter ordering** for better developer experience
- **Consistent API patterns** across all components

### Optimized Data Structures
- **Replaced complex cache entries** with efficient map-based storage for blocked events
- **Better memory usage** and improved performance
- **Simplified data access patterns**

## üîÑ Breaking Changes

- **Constructor API changes**: The RelayStore constructor now requires query relays as the first parameter and publish relays as optional variadic parameters
- **Removed default configurations**: All components now require explicit configuration
- **Deprecated constructors removed**: Old constructor methods have been removed in favor of the simplified API

## üöÄ Migration Guide

### For Existing Deployments

1. **Update constructor calls** to use the new parameter order:
   ```go
   // Old (deprecated)
   store := relaystore.NewWithQueryRemotes(queryUrls, publishUrls)
   
   // New (v1.2.0)
   store := relaystore.New(queryUrls, publishUrls...)
   ```

2. **Ensure explicit configuration** for all required parameters
3. **No configuration file changes** required - only code changes if using the library directly

### For Docker Deployments

- **No changes required** - Docker deployments continue to work as before
- **Environment variables remain the same**
- **Configuration files remain compatible**

## üìà Performance Impact

- **Significant improvement** in internal query processing performance
- **Reduced memory usage** through optimized data structures
- **Better concurrency** for high-traffic scenarios
- **Improved cache efficiency** with O(1) lookups

## üß™ Testing

- **All existing functionality** remains compatible
- **Enhanced test coverage** for new caching mechanisms
- **Performance benchmarks** included for internal query processing
- **Comprehensive integration tests** for all new features

## üìö Documentation

- **Updated API documentation** for new constructor signatures
- **Enhanced troubleshooting guides** for debugging internal requests
- **Performance tuning recommendations** for high-traffic deployments
- **Migration examples** for existing codebases

---

**Full commit history**: See the detailed commit log for complete technical details of all changes in this release.
