# v1.1.0 (stable)

Espelho de São Miguel 1.1.0 — where authentication meets mirroring. A Nostr relay aggregator that now seamlessly authenticates with upstream relays and continuously mirrors events for comprehensive coverage.

This release introduces major new capabilities for authentication passthrough, event mirroring, and enhanced error handling while maintaining full backward compatibility.

Summary highlights

- **Authentication Passthrough**: Automatically authenticates with upstream relays using configured relay key (supports both hex and nsec formats).
- **Event Mirroring**: Continuously mirrors events from query relays using "since now" filter for comprehensive event coverage.
- **Structured Error Handling**: Passes through machine-readable error prefixes from upstream relays (NIP-01 standard).
- **Enhanced Health Monitoring**: Separate health indicators for publish, query, and mirroring operations with configurable thresholds.
- **Smart Mirroring Logic**: Only requires mirroring when query relays are configured; gracefully handles partial availability.
- **Fail-Fast Behavior**: Relay exits with clear errors when configured query relays are unavailable.
- **Updated Dependencies**: Migrated from deprecated SubMany to SubscribeMany for better compatibility.

Changes (grouped)

Authentication & Security
- **Authentication Passthrough**: Relay automatically authenticates with upstream relays when required using RELAY_SECKEY.
- **Key Format Support**: Enhanced RELAY_SECKEY handling to support both raw hex keys and nsec bech32 encoded keys.
- **NIP-42 Support**: Added NIP-42 (Authentication) to supported NIPs list for seamless upstream relay authentication.
- **Automatic Retry**: If upstream relay requires authentication, relay attempts auth and retries publish automatically.

Event Mirroring & Aggregation
- **Continuous Mirroring**: Relay automatically mirrors events from query relays using "since now" filter.
- **Smart Logic**: Only requires mirroring when QUERY_REMOTES is configured; can run in publishing-only mode.
- **Event Injection**: Mirrored events are injected into local relay via khatru.BroadcastEvent() for comprehensive coverage.
- **Deduplication**: Automatic deduplication prevents duplicate events from multiple sources.
- **Real-time Updates**: Events are mirrored immediately as they arrive from upstream relays.

Error Handling & Reliability
- **Structured Errors**: Machine-readable error prefixes from upstream relays (NIP-01) are passed through to clients.
- **Error Format**: Returns errors in format "prefix: message (relay-url)" with source relay URL for context.
- **Supported Prefixes**: duplicate, pow, blocked, rate-limited, invalid, restricted, mute, error, auth-required.
- **Fail-Fast**: Relay exits with clear error messages when configured query relays are unavailable.
- **Graceful Degradation**: Works with partial relay availability (some relays down, others up).

Enhanced Monitoring & Statistics
- **Mirroring Metrics**: Added mirrored_events, mirror_attempts, mirror_successes, mirror_failures counters.
- **Relay Health**: Added live_relays and dead_relays counters for upstream relay connectivity.
- **Separate Health States**: Individual health indicators for publish, query, and mirroring operations.
- **Configurable Thresholds**: Health states based on consecutive failures (GREEN ≤2, YELLOW 3-9, RED ≥10).
- **Web Interface**: Enhanced health and stats pages with new mirroring and relay health information.

Technical Improvements
- **Updated Dependencies**: Migrated from deprecated SubMany to SubscribeMany for better go-nostr compatibility.
- **Improved Error Parsing**: Simplified error prefix extraction with proper handling of nested error messages.
- **Enhanced Logging**: Better verbose logging for authentication attempts and mirroring operations.
- **Health Monitoring**: Periodic relay health checks using EnsureRelay() with configurable thresholds.
- **JavaScript Fixes**: Fixed health page to properly handle HTTP 503 responses (unhealthy service status).

Configuration
- **RELAY_SECKEY**: New optional configuration for relay authentication (supports hex and nsec formats).
- **Smart Defaults**: Relay works without mirroring when no query relays are configured.
- **Backward Compatibility**: All existing configurations continue to work without changes.

Distribution
- **Multi-Platform**: Binaries for Linux, macOS, and Windows (AMD64/ARM64).
- **Docker Images**: Multi-architecture Docker images with latest dependencies.
- **Complete Archives**: Includes binaries, static assets, templates, docker-compose, and documentation.
- **Release Notes**: Comprehensive release notes with detailed feature descriptions.

Migration Notes
- **No Breaking Changes**: All existing configurations continue to work.
- **New Features**: Authentication and mirroring are optional and can be enabled via configuration.
- **Enhanced Monitoring**: New metrics available in stats and health endpoints.
- **Docker Users**: Update to new image tags for latest features.

Thanks
- Built on khatru and the Nostr community's work and ideas.
- Thanks to all contributors and testers who helped shape this release.
