# v1.3.0 ‚Äî Major Logging Refactoring & Concurrency Control

This release introduces a comprehensive logging refactoring and advanced concurrency control features, transforming the Espelho de S√£o Miguel into a more maintainable, debuggable, and performant system.

## üöÄ Major Logging Refactoring

### Centralized Logging System
- **Complete replacement** of all 76+ log statements with a structured logging package
- **Granular verbose control** with module and method-level filtering
- **Environment variable and command-line flag support** for flexible configuration
- **Consistent log formatting** with `[LEVEL] module.method: message` structure

### Enhanced Debugging Capabilities
- **Targeted debugging**: Enable verbose logging for specific modules or methods
- **Production ready**: Minimal performance impact when verbose logging is disabled
- **Docker friendly**: Perfect integration with containerized deployments
- **CI/CD compatible**: Environment variable control for automated testing

### Verbose Control Examples
```bash
# Enable all verbose logging
VERBOSE=1 ./saint-michaels-mirror

# Enable specific module
VERBOSE=relaystore ./saint-michaels-mirror

# Enable specific method
VERBOSE=relaystore.QueryEvents ./saint-michaels-mirror

# Enable multiple modules/methods
VERBOSE=relaystore.QueryEvents,mirror,main ./saint-michaels-mirror
```

## ‚ö° Advanced Concurrency Control

### Semaphore Implementation
- **Semaphore-based limiting** of concurrent FetchMany operations to 20 simultaneous calls
- **Prevention of upstream relay overload** from excessive concurrent requests
- **Real-time semaphore monitoring** with capacity, available slots, and wait count statistics
- **Enhanced query performance** through better resource management

### Monitoring & Statistics
- **New "Concurrency Control" section** on the `/stats` page
- **Real-time updates** every 10 seconds with semaphore health indicators
- **Performance insights** to identify bottlenecks and contention
- **Visual indicators** for semaphore health and resource utilization

## üîß Configuration Enhancements

### Granular Verbose Control
- **Environment Variables**:
  - `VERBOSE=1` or `VERBOSE=true`: Enable all verbose logging
  - `VERBOSE=relaystore`: Enable verbose for relaystore module only
  - `VERBOSE=relaystore.QueryEvents,mirror`: Enable specific methods and modules
  - `VERBOSE=`: Disable all verbose logging (production)

- **Command-Line Flags**:
  - `--verbose=relaystore`: Override environment variable
  - `--verbose=relaystore.QueryEvents`: Enable specific method
  - `--verbose=1`: Enable all verbose logging

### Docker Integration
```bash
# Enable all verbose logging
docker run -e VERBOSE=1 ghcr.io/girino/saint-michaels-mirror:latest

# Enable specific module
docker run -e VERBOSE=relaystore ghcr.io/girino/saint-michaels-mirror:latest

# Multiple modules
docker run -e VERBOSE=relaystore,mirror ghcr.io/girino/saint-michaels-mirror:latest
```

## üìä Enhanced Monitoring

### New Statistics
- **Semaphore Capacity**: Total concurrent operations allowed (20)
- **Semaphore Available**: Currently available slots
- **Semaphore Wait Count**: Queries waiting for semaphore slots

### Structured Logging Format
```
[DEBUG] relaystore.QueryEvents: attempting semaphore acquisition (wait count: 5)
[DEBUG] relaystore.QueryEvents: acquired semaphore for FetchMany (remaining slots: 19)
[INFO] mirror.StartMirroring: starting mirroring for relay wss://relay.example.com
[WARN] main: connection rate limited for IP 192.168.1.100
```

## üõ†Ô∏è Technical Improvements

### Code Quality
- **Centralized error handling**: New `logging.Fatal()` function for consistent error handling
- **Cleaner code**: Removed repetitive verbose conditionals throughout the codebase
- **Better performance**: Verbose filtering handled efficiently by the logging package
- **Consistent API**: All logging uses the same structured format

### Architecture
- **Modular design**: Logging package can be reused across projects
- **Environment integration**: Perfect for systemd services and CI/CD pipelines
- **Backward compatibility**: All existing functionality preserved
- **Future proof**: Extensible design for additional logging features

## üîç Developer Experience

### Debugging Capabilities
- **Granular control**: Debug specific modules or methods without enabling all verbose logging
- **Clear identification**: Module.method prefixes make it easy to identify log sources
- **Flexible configuration**: Support for both environment variables and command-line flags
- **Production safe**: Minimal performance impact when verbose logging is disabled

### Development Workflow
```bash
# Development with specific module debugging
VERBOSE=relaystore.QueryEvents go run ./cmd/saint-michaels-mirror

# Testing with mirror debugging
VERBOSE=mirror go test -v ./...

# Production deployment
VERBOSE= ./saint-michaels-mirror
```

## üîÑ Migration Guide

### From v1.2.x
**No Breaking Changes**: This release maintains full backward compatibility.

**New Features Available**:
1. **Enhanced Verbose Control**: Update your `VERBOSE` environment variable usage
2. **Semaphore Monitoring**: New statistics available on `/stats` page
3. **Improved Logging**: Better structured logs for debugging

**Recommended Actions**:
1. **Update Configuration**: Consider using the new granular verbose control
2. **Monitor Semaphore**: Check the new concurrency control statistics
3. **Test Verbose Logging**: Verify your debugging workflow with the new system

### Configuration Migration
**Old Configuration**:
```bash
VERBOSE=1  # All or nothing
```

**New Configuration**:
```bash
VERBOSE=relaystore.QueryEvents,mirror  # Granular control
```

## üêõ Bug Fixes

- **Fixed logging inconsistencies**: All log statements now use consistent formatting
- **Improved error handling**: Centralized fatal error handling with `logging.Fatal()`
- **Enhanced debugging**: Better verbose control for troubleshooting
- **Performance optimization**: Reduced overhead from verbose conditionals

## üìà Performance Impact

- **Minimal impact** when verbose logging is disabled (`VERBOSE=`)
- **Low impact** with targeted debugging (`VERBOSE=relaystore.QueryEvents`)
- **Medium impact** with module debugging (`VERBOSE=relaystore`)
- **Higher impact** with full debugging (`VERBOSE=1`)

## üß™ Testing

- **All existing functionality** remains compatible
- **Enhanced test coverage** for new logging system
- **Performance benchmarks** for semaphore operations
- **Comprehensive integration tests** for verbose control features

## üìö Documentation

- **Updated README.md** with comprehensive verbose logging guide
- **Migration guide** for upgrading from v1.2.x
- **Quick reference** for verbose logging options
- **Docker integration examples** for containerized deployments

## üéØ Best Practices

### Production Deployment
1. **Start with minimal verbose logging**: `VERBOSE=`
2. **Monitor semaphore statistics**: Check for high wait counts
3. **Gradually enable verbose logging**: Only when needed for debugging
4. **Use structured logs**: Take advantage of module.method prefixes

### Development Workflow
1. **Use granular verbose control**: Enable specific modules/methods
2. **Monitor semaphore contention**: Watch for performance bottlenecks
3. **Test with different configurations**: Verify behavior with various VERBOSE settings
4. **Leverage new monitoring**: Use semaphore statistics for optimization

---

**Full commit history**: See the detailed commit log for complete technical details of the logging refactoring and concurrency control implementation.
