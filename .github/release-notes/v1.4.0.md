# v1.4.0 ‚Äî Architectural Refactoring & Separation of Concerns

This release introduces a fundamental architectural shift in the Espelho de S√£o Miguel, separating query and publish responsibilities, introducing a custom JSON library for ordered data structures, implementing a global stats collection system, plus performance optimizations with auto-scaling workers and enhanced monitoring capabilities.

## ‚ö° Performance & Scalability Enhancements

### Auto-Scaling Broadcast Workers
- **Intelligent Defaults**: Broadcast worker count now automatically defaults to 2√ó the number of CPU cores
- **Hardware-Aware**: Automatically scales with your system resources
- **No Manual Tuning**: Optimal performance out of the box
- **Configurable**: Still can be overridden via `BROADCAST_WORKERS` environment variable

### Mandatory Relay Support
- **Guaranteed Delivery**: `BROADCAST_MANDATORY_RELAYS` now properly registers mandatory relays
- **Always Included**: Critical relays always receive events regardless of performance score
- **Essential for Redundancy**: Perfect for your own relay or backup systems
- **Per-Deployment Configuration**: Set based on your specific needs

### Execution Time Tracking
- **Comprehensive Statistics**: Added execution time tracking for broadcaststore operations
- **Consistent Monitoring**: Matches the pattern used in relaystore
- **Performance Analysis**: Track average and total execution times
- **Accurate Metrics**: Excludes cached events from timing for real performance data

### Enhanced Stats Page
- **New Performance Metrics**: "Avg Save Duration" and "Total Save Time" in stats page
- **Better Organization**: Performance statistics grouped with averages first, totals after
- **Visibility**: Monitor actual broadcast execution times across operations

## üèóÔ∏è Major Architecture Refactoring

### Separation of Query and Publish Stores
- **RelayStore is now query-only**: Specializes in fetching events from remote relays
- **BroadcastStore handles all publishing**: Uses intelligent relay discovery and ranking
- **Clear separation of concerns**: Each component has a single, well-defined responsibility
- **Better performance**: Specialized implementations for query vs. publish operations

**Technical Details:**
- `RelayStore`: Query-only, forwards events from remote relays to clients
- `BroadcastStore`: Publish-only, broadcasts events to the best available relays
- Both stores implement the `eventstore.Store` interface
- Both provide statistics via the global stats collector

## üìä Custom JSON Library with Ordered Structures

### Ordered Data Structures
- **JsonObject**: Ordered map that preserves field insertion order
- **JsonValue**: Type-safe values for int, float, string, bool, null
- **JsonList**: Ordered list of JsonEntity values
- **JsonEntity**: Common interface for all JSON types

### Benefits
- **Order Preservation**: Statistics display in a consistent, meaningful order
- **Type Safety**: No more `interface{}` type assertions
- **Predictable Output**: JSON output is deterministic and ordered
- **Better Debugging**: Consistent field ordering makes stats easier to read

## üìà Global Stats Collection System

### Singleton Stats Collector
- **Unified API**: Single `stats.GetCollector().GetAllStats()` call for all statistics
- **Automatic Registration**: Components self-register as `StatsProvider`s
- **Thread-Safe**: Efficient singleton pattern with `sync.Once`
- **Ordered Output**: Statistics display in registration order

### Stats Providers
- **RelayStore**: Query statistics (requests, failures, timing)
- **BroadcastStore**: Publish statistics (attempts, successes, health)
- **BroadcastManager**: Active relay management statistics
- **Broadcaster**: Event broadcasting statistics
- **MirrorManager**: Event mirroring statistics
- **AppStats**: Application runtime statistics

## üè• Enhanced Health Monitoring

### Health State System
- **Three-Tier Color System**: Green, Yellow, Red based on failure thresholds
- **Broadcast Health**: New health indicators for broadcast store
- **Main Health**: Considers all components (query, publish, mirror, broadcast)
- **Granular Indicators**: Separate health states for each subsystem

### Health States
- **GREEN**: All systems operational, no failures
- **YELLOW**: Some failures detected but within acceptable threshold
- **RED**: Critical failures exceeding acceptable threshold

### HTTP Status Codes
- `200 OK`: Healthy or degraded
- `503 Service Unavailable`: Unhealthy

## ‚öôÔ∏è Configuration System Overhaul

### Command-Line Flags for Everything
Every environment variable now has a corresponding command-line flag:

**Basic Settings:**
- `--addr`: Address to listen on
- `--query-remotes`: Query relay URLs
- `--verbose`: Verbose logging control

**Relay Identity:**
- `--relay-name`, `--relay-description`, `--relay-contact`
- `--relay-seckey`, `--relay-pubkey`, `--relay-icon`, `--relay-banner`

**Broadcast Settings:**
- `--max-publish-relays`: Maximum relays for publishing
- `--broadcast-workers`: Worker goroutines
- `--broadcast-cache-ttl`: Cache TTL
- `--broadcast-seed-relays`: Seed relays for discovery
- `--broadcast-mandatory-relays`: Mandatory relays

### Configuration Priority
1. Command-line flags (highest priority)
2. Environment variables (defaults)
3. Built-in defaults (fallback)

### Updated Parameters
- **Removed**: `PUBLISH_REMOTES` (handled by broadcast discovery)
- **Renamed**: `BROADCAST_TOP_N` ‚Üí `MAX_PUBLISH_RELAYS`
- **New**: `BROADCAST_SEED_RELAYS` (required for publishing)

## üîß Technical Improvements

### Broadcast System
- **Intelligent Relay Discovery**: Automatically discovers relays from seed relays
- **Success Rate Ranking**: Ranks relays by success rate for optimal delivery
- **Automatic Selection**: Chooses top N relays based on performance
- **Cache Optimization**: Uses broadcaster's cache, removed redundant local caches

### Code Organization
- **Package Reorganization**: BroadcastStore moved to `nostr-lib/eventstore/broadcaststore`
- **Consistent Structure**: Follows same pattern as other event stores
- **Reusable Components**: BroadcastStore can be used in other projects
- **Cleaner Imports**: Better organization of packages

### Performance
- **Better Concurrency**: Specialized stores for different operations
- **Optimized Broadcasting**: Intelligent relay selection reduces wasted traffic
- **Memory Efficiency**: Global stats collector reduces memory usage
- **Reduced Redundancy**: Eliminated duplicate cache implementations

## üìù Breaking Changes

### Configuration Changes
- **Removed**: `PUBLISH_REMOTES` environment variable
- **Renamed**: `BROADCAST_TOP_N` ‚Üí `MAX_PUBLISH_RELAYS`
- **New Required**: `BROADCAST_SEED_RELAYS` for publishing functionality

### API Changes
- **RelayStore.New()**: Simplified signature (removed `publishUrls`, `relaySecKey`)
- **StatsProvider**: Now returns `json.JsonEntity` instead of `interface{}`
- **RelayStore**: `SaveEvent()`, `ReplaceEvent()`, `DeleteEvent()` are now no-ops

### Migration Example
```bash
# BEFORE (v1.3.0)
QUERY_REMOTES=wss://relay1.com,wss://relay2.com
PUBLISH_REMOTES=wss://relay1.com,wss://relay2.com
BROADCAST_TOP_N=10

# AFTER (v1.4.0)
QUERY_REMOTES=wss://relay1.com,wss://relay2.com
MAX_PUBLISH_RELAYS=10
BROADCAST_SEED_RELAYS=wss://relay1.com,wss://relay2.com
```

## üîÑ Migration Guide

### For Query-Only Relays
No changes needed! Your existing `QUERY_REMOTES` configuration will continue to work.

### For Publishing Relays
1. Remove `PUBLISH_REMOTES` environment variable
2. Rename `BROADCAST_TOP_N` to `MAX_PUBLISH_RELAYS`
3. Add `BROADCAST_SEED_RELAYS` for broadcast discovery
4. Configure optional broadcast parameters

See `doc/MIGRATION_GUIDE_v1.4.0.md` for detailed instructions.

## üêõ Bug Fixes

- **Fixed stats ordering**: Statistics now display in a consistent order
- **Fixed broadcast cache**: Removed redundant local cache implementation
- **Fixed stats duplication**: Eliminated duplicate stats in `/stats` endpoint
- **Fixed health endpoint**: Now correctly uses global stats collector
- **Fixed mandatory relay registration**: Mandatory relays now properly registered with broadcast manager
- **Fixed stats page layout**: Performance metrics logically grouped with averages first

## üìà Performance Improvements

- **Better Concurrency**: Specialized stores for query vs. publish operations
- **Optimized Broadcasting**: Broadcast system ranks relays by success rate
- **Reduced Redundancy**: Removed duplicate cache implementations
- **Memory Efficiency**: Global stats collector reduces memory usage

## üîç Debugging Enhancements

- **Ordered Stats**: Statistics display in consistent order
- **Type Safety**: No more type assertions, compile-time safety
- **Better Health**: More granular health indicators for each subsystem
- **Clear Separation**: Easier to debug query vs. publish issues

## üìö Documentation Updates

- **README.md**: Updated with new architecture and configuration
- **CHANGELOG.md**: Complete list of all changes
- **MIGRATION_GUIDE_v1.4.0.md**: Step-by-step migration instructions
- **RELEASE_NOTES_v1.4.0.md**: Comprehensive release documentation
- **RELEASE_SUMMARY_v1.4.0.md**: Executive summary

## üéØ What's Next

### Improved Flexibility
- Specialized stores for different use cases
- Better configuration options
- Enhanced monitoring capabilities

### Better Developer Experience
- Type-safe statistics
- Consistent API
- Clearer code organization

## üß™ Testing

All changes have been tested for:
- Backward compatibility (query-only mode)
- Forward compatibility (publish with broadcast)
- Performance impact (minimal)
- Memory usage (optimized)
- Health monitoring (enhanced)

## üì¶ Release Information

- **Version**: 1.4.0
- **Codename**: "The Divider of Worlds"
- **Release Date**: October 27, 2025
- **Breaking Changes**: See Migration Guide
- **Requires**: nostr-lib with v0.0.0-20251027142055-a7108048b09e or later

## üôè Acknowledgments

- Built on the excellent [khatru](https://github.com/fiatjaf/khatru) framework
- Thanks to all contributors and testers
- Inspired by the Nostr protocol and community

---

**Espelho de S√£o Miguel v1.4.0** - The mirror that divides and unites.

*Copyright (c) 2025 Girino Vey. Licensed under Girino's Anarchist License (GAL).*

